# spectator-mode-scaffold 設計書

## 概要
リアルタイムWebSocket対戦ゲームに「観戦モード」を追加するアーキテクチャパターン。観戦専用WSチャンネル、観戦者追跡Map、観戦者数リアルタイム配信、読み取り専用UI、観戦者ライフサイクル管理を一貫して実装する。既存のゲーム配信（broadcast）を再利用し、観戦者への配信を最小コストで実現する。

## ユースケース
- マルチプレイヤーゲームに観戦機能を追加する
- 観戦者を通常プレイヤーと区別し、ゲーム操作を禁止する
- 観戦者数をリアルタイムで全クライアントに配信する
- 観戦者向けの読み取り専用UIを構築する
- 観戦者の接続/切断のライフサイクルを管理する

## 提案者
足軽2号（cmd_083のWebSocket対戦機能実装時に発見）

## 提案理由
neo_shogiプロジェクトでWebSocket観戦モードを実装した際、観戦者追跡・読み取り専用ビュー・観戦者数配信のパターンがリアルタイム対戦ゲーム共通の課題であると判断。特に「既存broadcastの再利用」と「コマンドフィルタリング」は、ゲームジャンルを問わず適用可能な汎用パターン。

## 承認
- 承認者: 殿（上様）
- 承認日: 2026-02-09
- cmd_088 にて承認

## 関連スキル
- websocket-game-sync: WebSocket接続管理とゲーム状態のbroadcast（ゲーム中の同期に焦点）
- lobby-game-bridge: ロビー部屋管理とゲームセッション作成の橋渡し（ゲーム前の導線に焦点）

## 差別化
- **websocket-game-sync** は「ゲーム中のプレイヤー間同期」に焦点。双方向通信（手の適用→broadcast）がメイン
- **lobby-game-bridge** は「ゲーム前のロビー管理」に焦点。部屋の作成→参加→ゲーム開始の導線がメイン
- **spectator-mode-scaffold（本スキル）** は「観戦」に特化。既存broadcast基盤に乗る片方向受信、コマンドフィルタリング、観戦者追跡・カウント、読み取り専用UIがメイン

## パターンの構成要素

### バックエンド
1. 観戦専用WSパス分類（`/ws/spectate/{gameId}`）
2. 観戦者追跡Map（`TVar (Map GameId (Map ClientId Connection))`）
3. 二重登録: クライアントリスト（broadcast受信用）＋ 観戦者リスト（カウント用）
4. 観戦者数broadcast（接続/切断時に全クライアントへ通知）
5. コマンドフィルタリング（観戦者のゲーム操作コマンドを拒否）
6. クリーンアップ（切断時に両Mapから除去＋カウント再broadcast）

### フロントエンド
1. useSpectator フック: 読み取り専用ゲーム状態、WS接続管理、指数バックオフ再接続
2. SpectatorBanner: 観戦モード表示バナー、観戦者数、退出ボタン
3. Board の isSpectator prop: クリック・ホバーイベントの無効化
4. メッセージハンドリング: state_update, spectator_count, move_notification, ai_complete
